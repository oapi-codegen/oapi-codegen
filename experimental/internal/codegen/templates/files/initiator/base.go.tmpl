{{/* Initiator base template - framework-agnostic HTTP client for webhooks/callbacks */}}
{{/* Input: InitiatorTemplateData */}}

// RequestEditorFn is the function signature for the RequestEditor callback function.
// It may already be defined if client code is also generated; this is a compatible redeclaration.
type RequestEditorFn func(ctx context.Context, req *http.Request) error

// HttpRequestDoer performs HTTP requests.
// The standard http.Client implements this interface.
type HttpRequestDoer interface {
	Do(req *http.Request) (*http.Response, error)
}

// {{ .Prefix }}Initiator sends {{ .PrefixLower }} requests to target URLs.
// Unlike Client, it has no stored base URL â€” the full target URL is provided per-call.
type {{ .Prefix }}Initiator struct {
	// Doer for performing requests, typically a *http.Client with any
	// customized settings, such as certificate chains.
	Client HttpRequestDoer

	// A list of callbacks for modifying requests which are generated before sending over
	// the network.
	RequestEditors []RequestEditorFn
}

// {{ .Prefix }}InitiatorOption allows setting custom parameters during construction.
type {{ .Prefix }}InitiatorOption func(*{{ .Prefix }}Initiator) error

// New{{ .Prefix }}Initiator creates a new {{ .Prefix }}Initiator with reasonable defaults.
func New{{ .Prefix }}Initiator(opts ...{{ .Prefix }}InitiatorOption) (*{{ .Prefix }}Initiator, error) {
	initiator := {{ .Prefix }}Initiator{}
	for _, o := range opts {
		if err := o(&initiator); err != nil {
			return nil, err
		}
	}
	if initiator.Client == nil {
		initiator.Client = &http.Client{}
	}
	return &initiator, nil
}

// With{{ .Prefix }}HTTPClient allows overriding the default Doer, which is
// automatically created using http.Client. This is useful for tests.
func With{{ .Prefix }}HTTPClient(doer HttpRequestDoer) {{ .Prefix }}InitiatorOption {
	return func(p *{{ .Prefix }}Initiator) error {
		p.Client = doer
		return nil
	}
}

// With{{ .Prefix }}RequestEditorFn allows setting up a callback function, which will be
// called right before sending the request. This can be used to mutate the request.
func With{{ .Prefix }}RequestEditorFn(fn RequestEditorFn) {{ .Prefix }}InitiatorOption {
	return func(p *{{ .Prefix }}Initiator) error {
		p.RequestEditors = append(p.RequestEditors, fn)
		return nil
	}
}

func (p *{{ .Prefix }}Initiator) applyEditors(ctx context.Context, req *http.Request, additionalEditors []RequestEditorFn) error {
	for _, r := range p.RequestEditors {
		if err := r(ctx, req); err != nil {
			return err
		}
	}
	for _, r := range additionalEditors {
		if err := r(ctx, req); err != nil {
			return err
		}
	}
	return nil
}
