{{- /*
  This template generates the receiver interface and handler functions for Chi.
  Input: ReceiverTemplateData
*/ -}}

// {{ .Prefix }}ReceiverInterface represents handlers for receiving {{ .PrefixLower }} requests.
type {{ .Prefix }}ReceiverInterface interface {
{{- range .Operations }}
{{ .SummaryAsComment }}
	// Handle{{ .GoOperationID }}{{ $.Prefix }} handles the {{ .Method }} {{ $.PrefixLower }} request.
	Handle{{ .GoOperationID }}{{ $.Prefix }}(w http.ResponseWriter, r *http.Request{{ if .HasParams }}, params {{ .ParamsTypeName }}{{ end }})
{{- end }}
}

// {{ .Prefix }}ReceiverMiddlewareFunc is a middleware function for {{ $.PrefixLower }} receiver handlers.
type {{ .Prefix }}ReceiverMiddlewareFunc func(http.Handler) http.Handler

{{ range .Operations }}
// {{ .GoOperationID }}{{ $.Prefix }}Handler returns an http.Handler for the {{ .GoOperationID }} {{ $.PrefixLower }}.
// The caller is responsible for registering this handler at the appropriate path.
func {{ .GoOperationID }}{{ $.Prefix }}Handler(si {{ $.Prefix }}ReceiverInterface, errHandler func(w http.ResponseWriter, r *http.Request, err error), middlewares ...{{ $.Prefix }}ReceiverMiddlewareFunc) http.Handler {
	if errHandler == nil {
		errHandler = func(w http.ResponseWriter, r *http.Request, err error) {
			http.Error(w, err.Error(), http.StatusBadRequest)
		}
	}

	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
{{- if .HasParams }}
		var err error
		_ = err

		var params {{ .ParamsTypeName }}
{{ range .QueryParams }}
{{- if or .Required .IsPassThrough .IsJSON }}
		if paramValue := r.URL.Query().Get("{{ .Name }}"); paramValue != "" {
{{- if .IsPassThrough }}
			params.{{ .GoName }} = {{ if .HasOptionalPointer }}&{{ end }}paramValue
{{- end }}
{{- if .IsJSON }}
			var value {{ .TypeDecl }}
			err = json.Unmarshal([]byte(paramValue), &value)
			if err != nil {
				errHandler(w, r, &UnmarshalingParamError{ParamName: "{{ .Name }}", Err: err})
				return
			}
			params.{{ .GoName }} = {{ if .HasOptionalPointer }}&{{ end }}value
{{- end }}
		}{{ if .Required }} else {
			errHandler(w, r, &RequiredParamError{ParamName: "{{ .Name }}"})
			return
		}{{ end }}
{{- end }}
{{- if .IsStyled }}
		err = {{ .BindFunc }}("{{ .Name }}", {{ .Required }}, r.URL.Query(), &params.{{ .GoName }})
		if err != nil {
			errHandler(w, r, &InvalidParamFormatError{ParamName: "{{ .Name }}", Err: err})
			return
		}
{{- end }}
{{ end }}
{{ range .HeaderParams }}
		if valueList, found := r.Header[http.CanonicalHeaderKey("{{ .Name }}")]; found {
			var {{ .GoVariableName }} {{ .TypeDecl }}
			n := len(valueList)
			if n != 1 {
				errHandler(w, r, &TooManyValuesForParamError{ParamName: "{{ .Name }}", Count: n})
				return
			}
{{- if .IsStyled }}
			err = {{ .BindFunc }}("{{ .Name }}", ParamLocationHeader, valueList[0], &{{ .GoVariableName }})
			if err != nil {
				errHandler(w, r, &InvalidParamFormatError{ParamName: "{{ .Name }}", Err: err})
				return
			}
{{- end }}
			params.{{ .GoName }} = {{ if .HasOptionalPointer }}&{{ end }}{{ .GoVariableName }}
		}{{ if .Required }} else {
			errHandler(w, r, &RequiredHeaderError{ParamName: "{{ .Name }}", Err: fmt.Errorf("header parameter {{ .Name }} is required, but not found")})
			return
		}{{ end }}
{{ end }}
{{- end }}
		handler := http.Handler(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			si.Handle{{ .GoOperationID }}{{ $.Prefix }}(w, r{{ if .HasParams }}, params{{ end }})
		}))

		for _, middleware := range middlewares {
			handler = middleware(handler)
		}

		handler.ServeHTTP(w, r)
	})
}
{{ end }}
